#!/bin/bash
# =============================================================================
# Pre-commit hook: Block commits containing credential patterns
# Copyright © 2024–2026 Jasper Ford
# SPDX-License-Identifier: AGPL-3.0-or-later
#
# Install: make install-hooks
# =============================================================================

RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

FOUND_SECRETS=0

# Patterns that indicate hardcoded credentials
# Format: "regex|||description"
PATTERNS=(
    'Password:\s*.+\S|||Hardcoded password value'
    'password\s*[=:]\s*["\x27][^"\x27]{6,}|||Password assignment'
    'ssh\s+-i\s+.*@[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+|||SSH command with IP address'
    '[Aa]zureuser@[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+|||Azure SSH connection string'
    'BEGIN\s+(RSA|DSA|EC|OPENSSH)\s+PRIVATE\s+KEY|||Private key'
    'AKIA[0-9A-Z]{16}|||AWS Access Key'
    'sk-[a-zA-Z0-9]{20,}|||API secret key'
    '[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+:8443|||Admin panel URL with IP'
)

for FILE in $STAGED_FILES; do
    # Skip binary files and lock files
    case "$FILE" in
        *.dll|*.exe|*.png|*.jpg|*.gif|*.ico|*.woff|*.woff2|*.lock)
            continue
            ;;
    esac

    CONTENT=$(git show ":$FILE" 2>/dev/null)
    if [ -z "$CONTENT" ]; then
        continue
    fi

    for PATTERN_ENTRY in "${PATTERNS[@]}"; do
        PATTERN=$(echo "$PATTERN_ENTRY" | sed 's/|||.*//')
        DESCRIPTION=$(echo "$PATTERN_ENTRY" | sed 's/.*|||//')

        MATCHES=$(echo "$CONTENT" | grep -nEi "$PATTERN" 2>/dev/null)
        if [ -n "$MATCHES" ]; then
            if [ "$FOUND_SECRETS" -eq 0 ]; then
                echo ""
                echo -e "${RED}=== BLOCKED: Potential credentials detected ===${NC}"
                echo ""
            fi
            FOUND_SECRETS=1
            echo -e "${YELLOW}$FILE${NC} - $DESCRIPTION:"
            echo "$MATCHES" | head -3 | while read -r line; do
                echo "  line $line"
            done
            echo ""
        fi
    done
done

# Block database dumps
for FILE in $STAGED_FILES; do
    case "$FILE" in
        *_dump.sql|*_backup.sql|*.dump|*prod*.sql)
            FOUND_SECRETS=1
            echo -e "${RED}BLOCKED:${NC} $FILE looks like a database dump"
            echo ""
            ;;
    esac
done

if [ "$FOUND_SECRETS" -ne 0 ]; then
    echo -e "${RED}Commit blocked.${NC} Remove credentials before committing."
    echo "If this is a false positive, use: git commit --no-verify"
    echo ""
    exit 1
fi

exit 0
